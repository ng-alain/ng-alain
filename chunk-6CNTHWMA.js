import{F as b,Fc as I,H as A,Lc as x,T as p,a as w,ba as l,bd as m,da as g,ea as C,fa as i,ga as T,j as d,k as y,l as S,od as a,pc as v,y as O}from"./chunk-2NBHHZGH.js";var U={store_key:"_token",token_invalid_redirect:!0,token_exp_offset:10,token_send_key:"token",token_send_template:"${token}",token_send_place:"header",login_url:"/login",refreshTime:3e3,refreshOffset:6e3,ignores:[/\/assets\//]};function E(e){return e.merge("auth",U)}function j(){return new f}var f=class{get(n){return JSON.parse(localStorage.getItem(n)||"{}")||{}}set(n,t){return localStorage.setItem(n,JSON.stringify(t)),!0}remove(n){localStorage.removeItem(n)}},D=new g("AUTH_STORE_TOKEN",{providedIn:"root",factory:j});function L(){return new J(i(a))}var J=(()=>{class e{store=i(D);refresh$=new y;change$=new S(null);interval$;_referrer={};_options;constructor(t){this._options=E(t)}get refresh(){return this.builderRefresh(),this.refresh$.pipe(p())}get login_url(){return this._options.login_url}get referrer(){return this._referrer}get options(){return this._options}set(t){let r=this.store.set(this._options.store_key,t);return this.change$.next(t),r}get(t){let r=this.store.get(this._options.store_key);return t?Object.assign(new t,r):r}clear(t={onlyToken:!1}){let r=null;t.onlyToken===!0?(r=this.get(),r.token="",this.set(r)):this.store.remove(this._options.store_key),this.change$.next(r)}change(){return this.change$.pipe(p())}builderRefresh(){let{refreshTime:t,refreshOffset:r}=this._options;this.cleanRefresh(),this.interval$=b(t).pipe(O(()=>{let o=this.get(),s=o.expired||o.exp||0;if(s<=0)return null;let c=new Date().valueOf()+r;return s<=c?o:null}),A(o=>o!=null)).subscribe(o=>this.refresh$.next(o))}cleanRefresh(){this.interval$&&!this.interval$.closed&&this.interval$.unsubscribe()}ngOnDestroy(){this.cleanRefresh()}static \u0275fac=function(r){return new(r||e)(C(a))};static \u0275prov=l({token:e,factory:e.\u0275fac})}return e})(),h=new g("DA_SERVICE_TOKEN",{providedIn:"root",factory:L}),_="_delonAuthSocialType",k="_delonAuthSocialCallbackByHref",te=(()=>{class e{tokenService=i(h);doc=i(v);router=i(m);_win=null;_winTime;observer;login(t,r="/",o={}){if(o=w({type:"window",windowFeatures:"location=yes,height=570,width=520,scrollbars=yes,status=yes"},o),localStorage.setItem(_,o.type),localStorage.setItem(k,r),o.type==="href"){this.doc.location.href=t;return}return this._win=window.open(t,"_blank",o.windowFeatures),this._winTime=setInterval(()=>{if(this._win&&this._win.closed){this.ngOnDestroy();let s=this.tokenService.get();s&&!s.token&&(s=null),s&&this.tokenService.set(s),this.observer.next(s),this.observer.complete()}},100),new d(s=>{this.observer=s})}callback(t){if(!t&&this.router.url.indexOf("?")===-1)throw new Error("url muse contain a ?");let r={token:""};if(typeof t=="string"){let c=t.split("?")[1].split("#")[0];r=this.router.parseUrl(`./?${c}`).queryParams}else r=t;if(!r||!r.token)throw new Error("invalide token data");this.tokenService.set(r);let o=localStorage.getItem(k)||"/";localStorage.removeItem(k);let s=localStorage.getItem(_);return localStorage.removeItem(_),s==="window"?window.close():this.router.navigateByUrl(o),r}ngOnDestroy(){clearInterval(this._winTime),this._winTime=null}static \u0275fac=function(r){return new(r||e)};static \u0275prov=l({token:e,factory:e.\u0275fac})}return e})();function N(e){return e!=null&&typeof e.token=="string"&&e.token.length>0}function R(e,n){let t=i(m),r=i(h),o=i(v);r.referrer.url=n||t.url,e.token_invalid_redirect===!0&&setTimeout(()=>{/^https?:\/\//g.test(e.login_url)?o.location.href=e.login_url:t.navigate([e.login_url])})}var F=new I(()=>!1);function H(e,n){if(e.context.get(F))return!0;if(Array.isArray(n.ignores)){for(let t of n.ignores)if(t.test(e.url))return!0}return!1}function P(e,n){return R(n),new d(t=>{let r="",o=new x({url:e.url,headers:e.headers,status:401,statusText:r});t.error(o)})}var $=(()=>{class e{srv=i(h);process(t){let r=N(this.srv.get());return r||R(this.srv.options,t),r}static \u0275fac=function(r){return new(r||e)};static \u0275prov=l({token:e,factory:e.\u0275fac,providedIn:"root"})}return e})(),re=(e,n)=>i($).process(n.url),ne=(e,n)=>i($).process(n.url);function W(e,n,t){let{token_send_template:r,token_send_key:o}=t,s=r.replace(/\$\{([\w]+)\}/g,(c,u)=>n[u]);switch(t.token_send_place){case"header":let c={};c[o]=s,e=e.clone({setHeaders:c});break;case"body":let u=e.body||{};u[o]=s,e=e.clone({body:u});break;case"url":e=e.clone({params:e.params.append(o,s)});break}return e}var oe=(e,n)=>{let t=E(i(a));if(H(e,t))return n(e);let r=i(h).get();return N(r)?n(W(e,r,t)):P(e,t)};var M=function(e){return e[e.Store=0]="Store",e}(M||{});function B(e,n){return{\u0275kind:e,\u0275providers:n}}function se(e){return T([(e??K()).\u0275providers])}function K(){return B(M.Store,[{provide:D,useClass:f}])}export{h as a,te as b,F as c,re as d,ne as e,oe as f,se as g};

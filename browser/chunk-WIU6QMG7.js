import{D as A,F as I,Mc as f,S as v,Vb as _,Yc as l,a as S,aa as h,ca as m,da as u,ea as c,j as g,k as O,l as b,oc as x,ra as T,uc as E,w as C}from"./chunk-XR424BDU.js";var M={store_key:"_token",token_invalid_redirect:!0,token_exp_offset:10,token_send_key:"token",token_send_template:"${token}",token_send_place:"header",login_url:"/login",ignores:[/\/login/,/assets\//,/passport\//],refreshTime:3e3,refreshOffset:6e3};function D(e){return e.merge("auth",M)}function U(){return new d}var d=class{get(t){return JSON.parse(localStorage.getItem(t)||"{}")||{}}set(t,i){return localStorage.setItem(t,JSON.stringify(i)),!0}remove(t){localStorage.removeItem(t)}},w=new m("AUTH_STORE_TOKEN",{providedIn:"root",factory:U});function L(){return new F(c(l),c(w))}var F=(()=>{let t=class t{constructor(n,r){this.store=r,this.refresh$=new O,this.change$=new b(null),this._referrer={},this._options=D(n)}get refresh(){return this.builderRefresh(),this.refresh$.pipe(v())}get login_url(){return this._options.login_url}get referrer(){return this._referrer}get options(){return this._options}set(n){let r=this.store.set(this._options.store_key,n);return this.change$.next(n),r}get(n){let r=this.store.get(this._options.store_key);return n?Object.assign(new n,r):r}clear(n={onlyToken:!1}){let r=null;n.onlyToken===!0?(r=this.get(),r.token="",this.set(r)):this.store.remove(this._options.store_key),this.change$.next(r)}change(){return this.change$.pipe(v())}builderRefresh(){let{refreshTime:n,refreshOffset:r}=this._options;this.cleanRefresh(),this.interval$=A(n).pipe(C(()=>{let o=this.get(),s=o.expired||o.exp||0;if(s<=0)return null;let a=new Date().valueOf()+r;return s<=a?o:null}),I(o=>o!=null)).subscribe(o=>this.refresh$.next(o))}cleanRefresh(){this.interval$&&!this.interval$.closed&&this.interval$.unsubscribe()}ngOnDestroy(){this.cleanRefresh()}};t.\u0275fac=function(r){return new(r||t)(u(l),u(w))},t.\u0275prov=h({token:t,factory:t.\u0275fac});let e=t;return e})(),p=new m("DA_SERVICE_TOKEN",{providedIn:"root",factory:L}),k="_delonAuthSocialType",y="_delonAuthSocialCallbackByHref",ne=(()=>{let t=class t{constructor(n,r,o){this.tokenService=n,this.doc=r,this.router=o,this._win=null}login(n,r="/",o={}){if(o=S({type:"window",windowFeatures:"location=yes,height=570,width=520,scrollbars=yes,status=yes"},o),localStorage.setItem(k,o.type),localStorage.setItem(y,r),o.type==="href"){this.doc.location.href=n;return}return this._win=window.open(n,"_blank",o.windowFeatures),this._winTime=setInterval(()=>{if(this._win&&this._win.closed){this.ngOnDestroy();let s=this.tokenService.get();s&&!s.token&&(s=null),s&&this.tokenService.set(s),this.observer.next(s),this.observer.complete()}},100),new g(s=>{this.observer=s})}callback(n){if(!n&&this.router.url.indexOf("?")===-1)throw new Error("url muse contain a ?");let r={token:""};if(typeof n=="string"){let a=n.split("?")[1].split("#")[0];r=this.router.parseUrl(`./?${a}`).queryParams}else r=n;if(!r||!r.token)throw new Error("invalide token data");this.tokenService.set(r);let o=localStorage.getItem(y)||"/";localStorage.removeItem(y);let s=localStorage.getItem(k);return localStorage.removeItem(k),s==="window"?window.close():this.router.navigateByUrl(o),r}ngOnDestroy(){clearInterval(this._winTime),this._winTime=null}};t.\u0275fac=function(r){return new(r||t)(u(p),u(_),u(f))},t.\u0275prov=h({token:t,factory:t.\u0275fac});let e=t;return e})();function N(e){return e!=null&&typeof e.token=="string"&&e.token.length>0}function R(e,t){let i=c(f),n=c(p),r=c(_);n.referrer.url=t||i.url,e.token_invalid_redirect===!0&&setTimeout(()=>{/^https?:\/\//g.test(e.login_url)?r.location.href=e.login_url:i.navigate([e.login_url])})}var J=new x(()=>!1);function H(e,t){if(e.context.get(J))return!0;if(Array.isArray(t.ignores)){for(let i of t.ignores)if(i.test(e.url))return!0}return!1}function P(e,t){return R(t),new g(i=>{let n="",r=new E({url:e.url,headers:e.headers,status:401,statusText:n});i.error(r)})}var $=(()=>{let t=class t{constructor(n){this.srv=n}process(n){let r=N(this.srv.get());return r||R(this.srv.options,n),r}};t.\u0275fac=function(r){return new(r||t)(u(p))},t.\u0275prov=h({token:t,factory:t.\u0275fac,providedIn:"root"});let e=t;return e})(),oe=(e,t)=>c($).process(t.url),se=(e,t)=>c($).process(t.url);function B(e,t,i){let{token_send_template:n,token_send_key:r}=i,o=n.replace(/\$\{([\w]+)\}/g,(s,a)=>t[a]);switch(i.token_send_place){case"header":let s={};s[r]=o,e=e.clone({setHeaders:s});break;case"body":let a=e.body||{};a[r]=o,e=e.clone({body:a});break;case"url":e=e.clone({params:e.params.append(r,o)});break}return e}var ie=(e,t)=>{let i=D(c(l));if(H(e,i))return t(e);let n=c(p).get();return N(n)?t(B(e,n,i)):P(e,i)};var j=function(e){return e[e.Store=0]="Store",e}(j||{});function K(e,t){return{\u0275kind:e,\u0275providers:t}}function ce(e){return T([(e??W()).\u0275providers])}function W(){return K(j.Store,[{provide:w,useClass:d}])}export{p as a,ne as b,J as c,oe as d,se as e,ie as f,ce as g};

import{G as b,I as A,Mc as T,S as d,Sc as I,a as y,aa as u,ca as p,ea as i,fa as C,hd as v,k as h,l as w,m as S,ma as g,ud as m,z as O}from"./chunk-LB3RSBOY.js";var M={store_key:"_token",token_invalid_redirect:!0,token_exp_offset:10,token_send_key:"token",token_send_template:"${token}",token_send_place:"header",login_url:"/login",refreshTime:3e3,refreshOffset:6e3,ignores:[/\/assets\//]};function x(e){return e.merge("auth",M)}function U(){return new l}var l=class{get(n){return JSON.parse(localStorage.getItem(n)||"{}")||{}}set(n,t){return localStorage.setItem(n,JSON.stringify(t)),!0}remove(n){localStorage.removeItem(n)}},E=new p("AUTH_STORE_TOKEN",{providedIn:"root",factory:U});function j(){return new L}var L=(()=>{class e{store=i(E);cogSrv=i(m);refresh$=new w;change$=new S(null);interval$;_referrer={};_options;constructor(){this._options=x(this.cogSrv)}get refresh(){return this.builderRefresh(),this.refresh$.pipe(d())}get login_url(){return this._options.login_url}get referrer(){return this._referrer}get options(){return this._options}set(t){let r=this.store.set(this._options.store_key,t);return this.change$.next(t),r}get(t){let r=this.store.get(this._options.store_key);return t?Object.assign(new t,r):r}clear(t={onlyToken:!1}){let r=null;t.onlyToken===!0?(r=this.get(),r.token="",this.set(r)):this.store.remove(this._options.store_key),this.change$.next(r)}change(){return this.change$.pipe(d())}builderRefresh(){let{refreshTime:t,refreshOffset:r}=this._options;this.cleanRefresh(),this.interval$=b(t).pipe(O(()=>{let o=this.get(),s=o.expired||o.exp||0;if(s<=0)return null;let c=new Date().valueOf()+r;return s<=c?o:null}),A(o=>o!=null)).subscribe(o=>this.refresh$.next(o))}cleanRefresh(){this.interval$&&!this.interval$.closed&&this.interval$.unsubscribe()}ngOnDestroy(){this.cleanRefresh()}static \u0275fac=function(r){return new(r||e)};static \u0275prov=u({token:e,factory:e.\u0275fac})}return e})(),f=new p("DA_SERVICE_TOKEN",{providedIn:"root",factory:j}),_="_delonAuthSocialType",k="_delonAuthSocialCallbackByHref",q=(()=>{class e{tokenService=i(f);doc=i(g);router=i(v);_win=null;_winTime;observer;login(t,r="/",o={}){if(o=y({type:"window",windowFeatures:"location=yes,height=570,width=520,scrollbars=yes,status=yes"},o),localStorage.setItem(_,o.type),localStorage.setItem(k,r),o.type==="href"){this.doc.location.href=t;return}return this._win=window.open(t,"_blank",o.windowFeatures),this._winTime=setInterval(()=>{if(this._win&&this._win.closed){this.ngOnDestroy();let s=this.tokenService.get();s&&!s.token&&(s=null),s&&this.tokenService.set(s),this.observer.next(s),this.observer.complete()}},100),new h(s=>{this.observer=s})}callback(t){if(!t&&this.router.url.indexOf("?")===-1)throw new Error("url muse contain a ?");let r={token:""};if(typeof t=="string"){let c=t.split("?")[1].split("#")[0];r=this.router.parseUrl(`./?${c}`).queryParams}else r=t;if(!r||!r.token)throw new Error("invalide token data");this.tokenService.set(r);let o=localStorage.getItem(k)||"/";localStorage.removeItem(k);let s=localStorage.getItem(_);return localStorage.removeItem(_),s==="window"?window.close():this.router.navigateByUrl(o),r}ngOnDestroy(){clearInterval(this._winTime),this._winTime=null}static \u0275fac=function(r){return new(r||e)};static \u0275prov=u({token:e,factory:e.\u0275fac})}return e})();function D(e){return e!=null&&typeof e.token=="string"&&e.token.length>0}function N(e,n){let t=i(v),r=i(f),o=i(g);r.referrer.url=n||t.url,e.token_invalid_redirect===!0&&setTimeout(()=>{/^https?:\/\//g.test(e.login_url)?o.location.href=e.login_url:t.navigate([e.login_url])})}var J=new T(()=>!1);function F(e,n){if(e.context.get(J))return!0;if(Array.isArray(n.ignores)){for(let t of n.ignores)if(t.test(e.url))return!0}return!1}function H(e,n){return N(n),new h(t=>{let r="",o=new I({url:e.url,headers:e.headers,status:401,statusText:r});t.error(o)})}var R=(()=>{class e{srv=i(f);process(t){let r=D(this.srv.get());return r||N(this.srv.options,t),r}static \u0275fac=function(r){return new(r||e)};static \u0275prov=u({token:e,factory:e.\u0275fac,providedIn:"root"})}return e})(),ee=(e,n)=>i(R).process(n.url),te=(e,n)=>i(R).process(n.url);function P(e,n,t){let{token_send_template:r,token_send_key:o}=t,s=r.replace(/\$\{([\w]+)\}/g,(c,a)=>n[a]);switch(t.token_send_place){case"header":let c={};c[o]=s,e=e.clone({setHeaders:c});break;case"body":{let a=e.body||{};a[o]=s,e=e.clone({body:a});break}case"url":e=e.clone({params:e.params.append(o,s)});break}return e}var re=(e,n)=>{let t=x(i(m));if(F(e,t))return n(e);let r=i(f).get();return D(r)?n(P(e,r,t)):H(e,t)};var $=(function(e){return e[e.Store=0]="Store",e})($||{});function W(e,n){return{\u0275kind:e,\u0275providers:n}}function ne(e){return C([(e??B()).\u0275providers])}function B(){return W($.Store,[{provide:E,useClass:l}])}export{f as a,q as b,J as c,ee as d,te as e,re as f,ne as g};
